"use strict";!function(){angular.module("nix.diet-graph-directive",["nix.track-api-client","angularMoment"]).run(["$templateCache",function(t){t.put("nix.diet-graph-directive.html",'<div class="nix_diet-graph">\n          <div class="panel panel-default panel-graph">\n            <div class="panel-heading">{{vm.title}}</div>\n            <div class="panel-body text-center">\n              <div style="display: inline-block" class="heat-map-calendar">\n                <button ng-disabled="vm.disableNavigation || vm.disablePrev" class="previous" class="btn">\n                  <i class="fa fa-chevron-left"></i>\n                </button>\n                <button ng-disabled="vm.disableNavigation || vm.disableNext" class="next" class="btn">\n                  <i class="fa fa-chevron-right"></i>\n                </button>\n                <div class="heatMap"></div>\n              </div>\n\n              <div class="row graph-summary" ng-if="vm.stats.total">\n                <div class="column">\n                  <p>Total Days Tracked</p>\n                  <strong>{{vm.stats.total}} Days</strong>\n                </div>\n                <div class="column">\n                  <p>% Days of Green</p>\n                  <strong>{{vm.stats.greenPercentage | number: 0}}%</strong>\n                </div>\n              </div>\n            </div>\n         </div>\n        </div>')}]).directive("dietGraph",["$filter","$log","$timeout","moment","$q",function(t,a,e,n,o){return{templateUrl:"nix.diet-graph-directive.html",replace:!0,restrict:"AE",controllerAs:"vm",scope:{},bindToController:{api:"=?",nutrientId:"=?",target:"=?",targetCalories:"=?",enableFdaRound:"=?",onClickHandler:"=?"},controller:["$scope","nixTrackApiClient",function(t,e){var o=this;o.disableNavigation=!1,o.disablePrev=!1,o.disableNext=!1,o.monthOffset=0,o.targetCalories&&a.warn('Since widget now supports multiple nutrients "targetCalories" is now deprecated, please use "target"'),o.target=o.target||o.targetCalories||2e3,o.nutrientId=o.nutrientId||208;var i={208:"total_cal",205:"total_carb",204:"total_fat",203:"total_protein",307:"total_sodium"};o.legend=[85*o.target/100,92.5*o.target/100,o.target,107.5*o.target/100,115*o.target/100],o.afterLoadDomain=function(t){o.stats.calculate(t)},o.stats={calculate:function(){var t=n().add(o.monthOffset,"month").format("YYYY-MM"),a=this.currentMonthTotals={};_.each(o.calendar,function(e,o){n(1e3*o).format("YYYY-MM")===t&&(a[o]=e)}),this.total=_.keys(a).length,this.green=_.filter(a,function(t){return t<=o.target}).length,this.greenPercentage=this.green/this.total*100},currentMonthTotals:null,total:null,green:null,greenPercentage:null},o.calendar={},o.loadTotals=function(){var t=o.monthOffset,a=n().startOf("month");t&&a.add(t,"month");var l=a.clone().add(1,"month");l.isAfter(n())&&(l=n().add(1,"day").startOf("day"));var r=o.loadTotals.loaded.indexOf(t)>-1;e("/reports/totals",{method:"GET",params:{begin:a.format("YYYY-MM-DD"),end:l.format("YYYY-MM-DD"),timezone:n.tz.guess()||"US/Eastern"},ignoreLoadingBar:r}).success(function(a){angular.forEach(a.dates,function(t){o.calendar[n(t.date).unix()]=t[i[o.nutrientId]]}),o.stats.calculate(),r||o.loadTotals.loaded.push(t)})},o.loadTotals.loaded=[],o.loadTotals(),o.api={refresh:function(){return o.loadTotals()}}}],link:function(a,n,i,l){var r=new CalHeatMap,s={next:n.find(".next"),previous:n.find(".previous")},d={208:{title:"Calories",round:"calories"},205:{title:"Carb",round:"total_carb"},204:{title:"Fat",round:"total_fat"},203:{title:"Protein",round:"protein"},307:{title:"Sodium",round:"sodium"}}[l.nutrientId];l.title=i.title||"Diet Logging Graph",r.formatNumber=function(a){return l.enableFdaRound&&(a=t("fdaRound")(a,d.round)),t("number")(a,0)};var c=250;r.init({animationDuration:c,tooltip:!0,itemSelector:n.find(".heatMap")[0],nextSelector:s.next[0],previousSelector:s.previous[0],domain:"month",subDomain:"x_day",subDomainTextFormat:"%d",range:1,start:new Date,maxDate:new Date,afterLoadPreviousDomain:function(t){l.monthOffset-=1,l.loadTotals(),l.afterLoadDomain(t),a.$apply()},afterLoadNextDomain:function(t){l.monthOffset+=1,l.loadTotals(),l.afterLoadDomain(t),a.$apply()},onMinDomainReached:function(t){l.disablePrev=!!t},onMaxDomainReached:function(t){l.disableNext=!!t},onClick:function(t,e){l.onClickHandler&&(l.onClickHandler(t,e),a.$apply())},legend:l.legend,displayLegend:!0,legendHorizontalPosition:"center",cellSize:28,label:{position:"top",align:"left",offset:{x:-103,y:0}},weekStartOnMonday:!1,domainLabelFormat:"%B %Y",subDomainTitleFormat:{empty:"not tracked",filled:"{count} "+d.title}});var u=o.resolve();n.on("click","button.next, button.previous",function(t){l.disableNavigation=!0,a.$apply(),u=e(function(){return l.disableNavigation=!1},c+5)}),a.$watchCollection("vm.calendar",function(){var t=l.calendar;t&&u.then(function(){try{r.update(t),r.options.data=t}catch(a){}})})}}}])}();