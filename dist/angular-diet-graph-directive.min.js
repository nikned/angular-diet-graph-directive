"use strict";!function(){angular.module("nix.diet-graph-directive",["nix.track-api-client","angularMoment"]).run(["$templateCache",function(t){t.put("nix.diet-graph-directive.html",'<div class="nix_diet-graph">\n          <div class="panel panel-default panel-graph">\n            <div class="panel-heading">{{vm.title}}</div>\n            <div class="panel-body text-center">\n              <div style="display: inline-block" class="heat-map-calendar">\n                <button ng-disabled="vm.disableNavigation || vm.disablePrev" class="previous" class="btn">\n                  <i class="fa fa-chevron-left"></i>\n                </button>\n                <button ng-disabled="vm.disableNavigation || vm.disableNext" class="next" class="btn">\n                  <i class="fa fa-chevron-right"></i>\n                </button>\n                <div class="heatMap"></div>\n              </div>\n\n              <div class="row graph-summary" ng-if="vm.stats.total">\n                <div class="column">\n                  <p>Total Days Tracked</p>\n                  <strong>{{vm.stats.total}} Days</strong>\n                </div>\n                <div class="column">\n                  <p>% Days of Green</p>\n                  <strong>{{vm.stats.greenPercentage | number: 0}}%</strong>\n                </div>\n              </div>\n            </div>\n         </div>\n        </div>')}]).directive("dietGraph",["$filter","$log","$timeout","moment","$q",function(t,a,n,e,i){return{templateUrl:"nix.diet-graph-directive.html",replace:!0,restrict:"AE",controllerAs:"vm",scope:{},bindToController:{api:"=?",nutrientId:"=?",target:"=?",targetCalories:"=?",enableFdaRound:"=?",onClickHandler:"=?",initialDisplayDate:"=?"},controller:["$scope","nixTrackApiClient",function(t,n){var i=this;i.disableNavigation=!1,i.disablePrev=!1,i.disableNext=!1,i.monthOffset=0,i.targetCalories&&a.warn('Since widget now supports multiple nutrients "targetCalories" is now deprecated, please use "target"'),i.target=i.target||i.targetCalories||2e3,i.nutrientId=i.nutrientId||208;var o={208:"total_cal",205:"total_carb",204:"total_fat",203:"total_protein",307:"total_sodium"};i.legend=[85*i.target/100,92.5*i.target/100,i.target,107.5*i.target/100,115*i.target/100],i.afterLoadDomain=function(t){i.stats.calculate(t)},i.stats={calculate:function(){var t=e().add(i.monthOffset,"month").format("YYYY-MM"),a=this.currentMonthTotals={};_.each(i.calendar,function(n,i){e(1e3*i).format("YYYY-MM")===t&&(a[i]=n)}),this.total=_.keys(a).length,this.green=_.filter(a,function(t){return t<=i.target}).length,this.greenPercentage=this.green/this.total*100},currentMonthTotals:null,total:null,green:null,greenPercentage:null},i.calendar={};var l=e(i.initialDisplayDate);i.loadTotals=function(){var t=i.monthOffset,a=l.clone().startOf("month");t&&a.add(t,"month");var r=a.clone().add(1,"month"),s=i.loadTotals.loaded.indexOf(t)>-1;n("/reports/totals",{method:"GET",params:{begin:a.format("YYYY-MM-DD"),end:r.format("YYYY-MM-DD"),timezone:e.tz.guess()||"US/Eastern"},ignoreLoadingBar:s}).success(function(a){angular.forEach(a.dates,function(t){i.calendar[e(t.date).unix()]=t[o[i.nutrientId]]}),i.stats.calculate(),s||i.loadTotals.loaded.push(t)})},i.loadTotals.loaded=[],i.loadTotals(),i.api={refresh:function(){return i.loadTotals()}}}],link:function(a,o,l,r){var s=new CalHeatMap,d={next:o.find(".next"),previous:o.find(".previous")},c={208:{title:"Calories",round:"calories"},205:{title:"Carb",round:"total_carb"},204:{title:"Fat",round:"total_fat"},203:{title:"Protein",round:"protein"},307:{title:"Sodium",round:"sodium"}}[r.nutrientId];r.title=l.title||"Diet Logging Graph",s.formatNumber=function(a){return r.enableFdaRound&&(a=t("fdaRound")(a,c.round)),t("number")(a,0)};var u=250;s.init({animationDuration:u,tooltip:!0,itemSelector:o.find(".heatMap")[0],nextSelector:d.next[0],previousSelector:d.previous[0],domain:"month",subDomain:"x_day",subDomainTextFormat:"%d",range:1,start:e(r.initialDisplayDate).toDate(),afterLoadPreviousDomain:function(t){n(function(){r.monthOffset-=1,r.loadTotals(),r.afterLoadDomain(t)})},afterLoadNextDomain:function(t){n(function(){r.monthOffset+=1,r.loadTotals(),r.afterLoadDomain(t)})},onMinDomainReached:function(t){r.disablePrev=!!t},onMaxDomainReached:function(t){r.disableNext=!!t},onClick:function(t,n){r.onClickHandler&&(r.onClickHandler(t,n),a.$apply())},legend:r.legend,displayLegend:!0,legendHorizontalPosition:"center",cellSize:28,label:{position:"top",align:"left",offset:{x:-103,y:0}},weekStartOnMonday:!1,domainLabelFormat:"%B %Y",subDomainTitleFormat:{empty:"not tracked",filled:"{count} "+c.title}});var f=i.resolve();o.on("click","button.next, button.previous",function(t){r.disableNavigation=!0,a.$apply(),f=n(function(){return r.disableNavigation=!1},u+5)}),r.api.jumpTo=function(t){s.jumpTo(e(t).toDate())},a.$watchCollection("vm.calendar",function(){var t=r.calendar;t&&f.then(function(){try{s.update(t),s.options.data=t}catch(a){}})})}}}])}();